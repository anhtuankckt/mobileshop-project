<%- include("./layout/head.ejs", {title: "Product Details"}) -%>
<%- include("./layout/header.ejs") -%>
<%- include("./layout/menu.ejs") -%>
<%- include("./layout/slider.ejs") -%>

<!--	List Product	-->
<div id="product">
  <% if (product) { %>
  <div id="product-head" class="row">
    <div id="product-img" class="col-lg-6 col-md-6 col-sm-12">
      <div class="product-image-container">
        <div class="product-image-main">
          <img class="img-feature" src="<%=`${baseUrlImage}/${product?.thumbnails[0]}`%>" />
          <div class="control prev">
            <box-icon name='chevron-left'></box-icon>
          </div>
          <div class="control next">
            <box-icon name='chevron-right'></box-icon>
          </div>
        </div>
        <div class="product-image-list">
          <% for (let img of product?.thumbnails) { %>
          <div><img src="<%=`${baseUrlImage}/${img}`%>"></div>
          <% } %>
        </div>
      </div>
    </div>
    <div id="product-details" class="col-lg-6 col-md-6 col-sm-12">
      <h1><%=product?.name%></h1>
      <ul>
        <li><span>Bảo hành:</span> <%=product?.warranty%></li>
        <li><span>Phụ kiện:</span> <%=product?.accessories%></li>
        <li><span>Tình trạng:</span> <%=product?.status%></li>
        <li><span>Khuyến Mãi:</span> <%-product?.promotion%></li>
        <% if (product.is_stock) { %>
        <li><span>Số lượng kho:</span> <%=product?.store%></li>
        <% } %>
        <li id="price">Giá Bán (chưa bao gồm VAT)</li>
        <li id="price-number"><%=vndPrice(product?.price)%>VND</li>
        <li id="status" class="<%=!product?.is_stock && 'text-danger'%>">
          <%=product?.is_stock ? 'Còn hàng' : 'Hết hàng'%>
        </li>
      </ul>
      <% if(product?.is_stock){%>
      <form method="post" action="/add-to-cart">
        <input type="hidden" name="id" value="<%=product?.id%>">
        <div class="form-row align-items-center">
          <div class="col-sm-3 my-1">
            <div class="input-group">
              <input type="number" class="form-control" min="1" value="1" name="qty" id="quantity" placeholder="Số lượng">
            </div>
          </div>
          <div class="col-auto my-1">
            <button type="submit" class="btn btn-primary">Thêm vào giỏ hàng</button>
          </div>
        </div>
      </form>
      <% }%>
    </div>
  </div>
  <div id="product-body" class="row">
    <div class="col-lg-12 col-md-12 col-sm-12">
      <h3><%=product?.name%></h3>
      <p><%-product?.description%></p>
    </div>
  </div>

  <% } else { %>
  <div id="product-head" class="row">
    <div id="product-img" class="col-lg-6 col-md-6 col-sm-12">
      <img src="images/product-1.png">
    </div>
    <div id="product-details" class="col-lg-6 col-md-6 col-sm-12">
      <h1>iPhone X - 64GB Silver</h1>
      <ul>
        <li><span>Bảo hành:</span> 12 Tháng</li>
        <li><span>Đi kèm:</span> Hộp, sách, sạc, cáp, tai nghe</li>
        <li><span>Tình trạng:</span> Máy Mới 100%</li>
        <li><span>Khuyến Mại:</span> Dán Màn Hình 3 lớp</li>
        <li id="price">Giá Bán (chưa bao gồm VAT)</li>
        <li id="price-number">22.990.000đ</li>
        <li id="status">Còn hàng</li>
      </ul>
      <div id="add-cart"><a href="#">Mua ngay</a></div>
    </div>
  </div>
  <div id="product-body" class="row">
    <div class="col-lg-12 col-md-12 col-sm-12">
      <h3>Đánh giá về iPhone X 64GB</h3>
      <p>
        Màn hình OLED có hỗ trợ HDR là một sự nâng cấp mới của Apple thay vì màn hình LCD với IPS được tìm thấy trên iPhone 8 và iPhone 8 Plus đem đến tỉ lệ tương phản cao hơn đáng kể là 1.000.000: 1, so với 1.300: 1 ( iPhone 8 Plus ) và 1.400: 1 ( iPhone 8 ).
      </p>
      <p>
        Màn hình OLED mà Apple đang gọi màn hình Super Retina HD có thể hiển thị tông màu đen sâu hơn. Điều này được thực hiện bằng cách tắt các điểm ảnh được hiển thị màu đen còn màn hình LCD thông thường, những điểm ảnh đó được giữ lại. Không những thế, màn hình OLED có thể tiết kiệm pin đáng kể.
      </p>
      <p>
        Cả ba mẫu iPhone mới đều có camera sau 12MP và 7MP cho camera trước, nhưng chỉ iPhone X và iPhone 8 Plus có thêm một cảm biến cho camera sau. Camera kép trên máy như thường lệ: một góc rộng và một tele. Vậy Apple đã tích hợp những gì vào camera của iPhone X?
      </p>
      <p>
        Chống rung quang học (OIS) là một trong những tính năng được nhiều hãng điện thoại trên thế giới áp dụng. Đối với iPhone X, hãng tích hợp chống rung này cho cả hai camera, không như IPhone 8 Plus chỉ có OIS trên camera góc rộng nên camera tele vẫn rung và chất lượng bức hình không đảm bảo.
      </p>
      <p>
        Thứ hai, ống kính tele của iPhone 8 Plus có khẩu độ f / 2.8, trong khi iPhone X có ống kính tele f / 2.2, tạo ra một đường cong nhẹ và có thể chụp thiếu sáng tốt hơn với ống kính tele trên iPhone X.
      </p>
      <p>
        Portrait Mode là tính năng chụp ảnh xóa phông trước đây chỉ có với camera sau của iPhone 7 Plus, hiện được tích hợp trên cả iPhone 8 Plus và iPhone X. Tuy nhiên, nhờ sức mạnh của cảm biến trên mặt trước của iPhone X, Camera TrueDepth cũng có thể chụp với Potrait mode.
      </p>
    </div>
  </div>
  <% } %>

  <!--	Comment	-->
  <div id="comment" class="row">
    <div class="col-lg-12 col-md-12 col-sm-12">
      <h3>Bình luận sản phẩm</h3>
      <form id="commentFormParrent" method="post" action="/product/<%=product?.id%>" onSubmit="return false">
        <div class="form-group comment-group">
          <label>Tên:</label>
          <input name="full_name" required type="text" class="form-control comment-control">
        </div>
        <div class="form-group comment-group">
          <label>Email:</label>
          <input name="email" required type="email" class="form-control comment-control" id="pwd">
        </div>
        <div class="form-group comment-group">
          <label>Nội dung:</label>
          <textarea name="body" required rows="5" class="form-control comment-control"></textarea>
        </div>
        <div class="g-recaptcha" data-sitekey="6Ld4WcApAAAAACuc8vHn6baM07Qwmbq-q3PVcqcx"></div>
        <button onClick="submitForm()" name="sbm" class="btn btn-primary">Gửi</button>
      </form>
    </div>
  </div>
  <!--	End Comment	-->

  <!--	Comments List	-->
  <% if (parrentComments.length >= 1) { %>
  <div id="comments-list" class="row">
    <div class="col-lg-12 col-md-12 col-sm-12">
      <% for (let comment of parrentComments) { %>
      <div class="comment-item">
        <ul>
          <li><b><%=comment?.full_name%></b></li>
          <li><%=timesAgo(comment?.createdAt)%></li>
          <li>
            <p class="text-body"><%=comment?.body%></p>
          </li>
          <% if (childComments) { %>
          <% for (let com of childComments) { %>
          <% if (comment?.id === com?.parrent_comment_id.toString()) { %>
          <div id="commentItem" class="comment-item">
            <ul>
              <li><b><%=com?.full_name%></b></li>
              <li><%=timesAgo(com?.createdAt)%></li>
              <li>
                <p class="text-body"><%=com?.body%></p>
              </li>
              <li style="width: 50%; margin: 0 auto;"></li>
            </ul>
          </div>
          <% } %>
          <% } %>
          <%} %>
          <% if (commentId === comment.id) { %>
          <form id="commentFormChild" method="post" action="/product/<%=product?.id%>" onSubmit="return false">
            <div class="form-group comment-group child-group">
              <label>Tên:</label>
              <input name="full_name" required type="text" class="form-control comment-control">
            </div>
            <div class="form-group comment-group child-group">
              <label>Email:</label>
              <input name="email" required type="email" class="form-control comment-control">
            </div>
            <div class="form-group comment-group child-group">
              <label>Nội dung:</label>
              <textarea name="body" required rows="2" class="form-control comment-control"></textarea>
            </div>
            <input name="commentId" value="<%=comment?.id%>" type="hidden" />
            <div class="g-recaptcha" data-sitekey="6Ld4WcApAAAAACuc8vHn6baM07Qwmbq-q3PVcqcx"></div>
            <button onclick="submitFormChild()" name="sbm" class="btn btn-primary">Gửi</button>
            <button name="sbm" class="btn btn-warning"><a href="/product/<%=product?.id%>">Hủy</a></button>
          </form>
          <% } else { %>
          <button name="sbm" class="btn btn-primary">
            <a href="/product/<%=product?.id%>?commentId=<%=comment?.id%>" style="color: #fff; text-decoration-line: none;">Trả lời</a>
          </button>
          <% } %>
          <li></li>
        </ul>
      </div>
      <% } %>
    </div>
  </div>
  <% } %>
  <!--	End Comments List	-->
</div>
<!--	End Product	-->
<div id="pagination">
  <ul class="pagination">
    <% if (currentPage > 1) { %>
    <li class="page-item"><a class="page-link" href="/product/<%=id%>?page=<%=currentPage - 1%>">Trang trước</a></li>
    <% } %>

    <% (pages && pages.forEach((page) => { %>
    <% if (page === '...') { %>
    <li class="page-item"><span class="page-link"><%=page%></span></li>
    <% } else { %>
    <li class="page-item <%=currentPage == page && 'active'%>"><a class="page-link" href="/product/<%=id%>?page=<%=page%>"><%=page%></a></li>
    <% } %>
    <% })) %>

    <% if (currentPage < totalPages) { %>
    <li class="page-item"><a class="page-link" href="/product/<%=id%>?page=<%=currentPage + 1%>">Trang sau</a></li>
    <% } %>
  </ul>
</div>

<script>
  function submitForm() {
    const recaptchaResponse = document.querySelector('.g-recaptcha-response').value
    const fullNameParrent = document.querySelector('[name="full_name"]').value
    const emailParrent = document.querySelector('[name="email"]').value
    const bodyParrent = document.querySelector('[name="body"]').value

    if (recaptchaResponse.trim().length > 0 && fullNameParrent.trim().length > 0 && emailParrent.trim().length > 0 && bodyParrent.trim().length > 0) {
      alert('Bình luận thành công!')
      document.getElementById('commentFormParrent').submit()
    } else {
      alert('Để bình luận: Nhập reCAPTCHA và các trường không để trống!')
      return false
    }
  }

  function submitFormChild() {
    const recaptchaResponse = document.getElementById('commentFormChild').querySelector('.g-recaptcha-response').value
    const fullNameParrent = document.getElementById('commentFormChild').querySelector('[name="full_name"]').value
    const emailParrent = document.getElementById('commentFormChild').querySelector('[name="email"]').value
    const bodyParrent = document.getElementById('commentFormChild').querySelector('[name="body"]').value

    if (recaptchaResponse.trim().length > 0 && fullNameParrent.trim().length > 0 && emailParrent.trim().length > 0 && bodyParrent.trim().length > 0) {
      alert('Bình luận thành công!')
      document.getElementById('commentFormChild').submit()
    } else {
      alert('Để bình luận: Nhập reCAPTCHA và các trường không để trống!')
      return false
    }
  }
</script>

<script>
  const imgFeature = document.querySelector('.img-feature')
  const listImage = document.querySelectorAll('.product-image-list img')
  const prevBtn = document.querySelector('.prev')
  const nextBtn = document.querySelector('.next')

  let currentIndex = 0

  function updateImageByIndex(index) {
    listImage.forEach(item => {
      item.classList.remove('activeImage')
    })

    currentIndex = index
    imgFeature.src = listImage[index].getAttribute('src')
    listImage[index].classList.add('activeImage')
  }

  listImage.forEach((imgElement, index) => {
    imgElement.addEventListener('click', function(e) {
      imgFeature.style.opacity = '0'
      setTimeout(() => {
        updateImageByIndex(index)
        imgFeature.style.opacity = '1'
      }, 350)
    })
  })

  prevBtn.addEventListener('click', function(e) {
    if (currentIndex == 0) {
      currentIndex = listImage.length - 1
    } else {
      currentIndex--
    }
    imgFeature.style.opacity = '0'
    setTimeout(() => {
      updateImageByIndex(currentIndex)
      imgFeature.style.opacity = '1'
    }, 350)
  })

  nextBtn.addEventListener('click', function(e) {
    if (currentIndex == listImage.length - 1) {
      currentIndex = 0
    } else {
      currentIndex++
    }
    imgFeature.style.opacity = '0'
    setTimeout(() => {
      updateImageByIndex(currentIndex)
      imgFeature.style.opacity = '1'
    }, 350)
  })

  updateImageByIndex(0)
</script>

<%- include("./layout/sidebar.ejs") -%>
<%- include("./layout/footer.ejs") -%>